<html>
<head>
  <title>day06-libevent</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/306387 (zh-CN, DDL); Windows/10.0.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 12pt;
    }
  </style>
</head>
<body>
<a name="2495"/>
<h1>day06-libevent</h1>

<div>
<span><div><div><div>学习目标</div><ol start="1"><li>描述什么是libevent并掌握如何安装</li><li>掌握event_base的作用和使用方法</li><li>熟悉掌握libevent库中的事件循环</li><li>掌握事件的Event使用方法</li><li>掌握BufferEvent的工作方式</li><li>掌握使用libenent实现tcp服务器流程</li><li>掌握使用ibenent实现tcp客户端流程</li></ol><div><br/></div></div><div><br/></div><div><br/></div><div>libevent  核心   以事件触发,自动回调</div><div><br/></div><div>1 libevent安装</div><div><br/></div><div>a&gt;解压</div><div><img src="day06-libevent_files/Image.png" type="image/png" data-filename="Image.png"/></div><div>b&gt;./configure   检测安装环境,生成makefile</div><div>c&gt; make  编译代码</div><div>d&gt;sudo  make install</div><div><br/></div><div><br/></div><div>安装库的目录在</div><div><img src="day06-libevent_files/Image [1].png" type="image/png" data-filename="Image.png"/></div><div>头文件目录:</div><div>/usr/local/include</div><div><br/></div><div><br/></div><div>ubuntu18版本安装是出现 问题</div><div><span style="text-indent: 0mm; min-height: 10pt; font-family: 微软雅黑; color: rgb(0, 64, 128); font-size: 8pt;"> error while loading shared libraries: libevent-2.0.so.5: cannot open shared object file: No such file or directory</span></div><div>解决办法是:sudo <span style="text-indent: 0mm; min-height: 10pt; font-family: 微软雅黑; color: rgb(0, 64, 128); font-size: 8pt;">ln -s /usr/local/lib/libevent-2.0.so.5 /usr/lib/libevent-2.0.so.5</span></div><div><br/></div><div>gcc dem.o.c -o demo  -levent</div><div><br/></div><div><br/></div><div>2 event_base结构体</div><div>结构体作用就是相当于epoll里面的根节点</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-weight: bold; font-family: Monaco; color: rgb(51, 51, 51);-en-paragraph:true;"><font style="font-size: 12pt;">struct event_base *event_base_new(void);.//创建event_base结构体</font></span></div></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-weight: bold; font-family: Monaco; color: rgb(51, 51, 51);-en-paragraph:true;"><font style="font-size: 12pt;">void event_base_free(struct event_base *);//释放<span style="font-weight: bold; font-family: Monaco; color: rgb(51, 51, 51); font-size: 12pt;">event_base结构体</span> </font></span></div></div><div><br/></div><div><br/></div><div>监听事件产生</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-weight: bold; font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">int</span> <span style="font-weight: bold; font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">event_base_loop(</span><span style="font-weight: bold; font-family: 新宋体; color: blue; background: white;-en-paragraph:true;">struct</span> <span style="font-weight: bold; font-family: 新宋体; color: rgb(43, 145, 175); background: white;-en-paragraph:true;">event_base</span> <span style="font-weight: bold; font-family: 新宋体; color: black; background: white;-en-paragraph:true;">*base,</span> <span style="font-weight: bold; font-family: 新宋体; color: blue; background: white;-en-paragraph:true;">int</span> <span style="font-weight: bold; font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">flags);//循环监听</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black;-en-paragraph:true;">   </span> <span style="font-family: 新宋体; color: black;-en-paragraph:true;">flags</span><span style="font-family: 新宋体; color: black;-en-paragraph:true;">的取值：</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black;-en-paragraph:true;">   </span> <span style="font-family: 新宋体; color: blue; background: white;-en-paragraph:true;">#define</span> <span style="font-family: 新宋体; color: rgb(111, 0, 138); background: white;-en-paragraph:true;">EVLOOP_ONCE</span><span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">  </span> <span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">0x01</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black;-en-paragraph:true;">   </span> <span style="font-family: 新宋体; color: black;-en-paragraph:true;">只触发一次，如果事件没有被触发，阻塞等待</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black;-en-paragraph:true;">   </span> <span style="font-family: 新宋体; color: blue; background: white;-en-paragraph:true;">#define</span> <span style="font-family: 新宋体; color: rgb(111, 0, 138); background: white;-en-paragraph:true;">EVLOOP_NONBLOCK</span><span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">  </span> <span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">0x02</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black;-en-paragraph:true;">   </span> <span style="font-family: 新宋体; color: black;-en-paragraph:true;">非阻塞方式检测事件是否被触发，不管事件触发与否，都会立即返回</span></font></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black;-en-paragraph:true;">而大多数我们都调用</span><span style="font-family: 新宋体; color: black;-en-paragraph:true;">libevent</span><span style="font-family: 新宋体; color: black;-en-paragraph:true;">给我们提供的另外一个</span><span style="font-family: 新宋体; color: black;-en-paragraph:true;">api</span><span style="font-family: 新宋体; color: black;-en-paragraph:true;">：</span></font></div><div><font style="font-size: 12pt;"><span style="text-indent: 21pt; font-weight: bold; font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">int</span> <span style="text-indent: 21pt; font-weight: bold; font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">event_base_dispatch(</span><span style="text-indent: 21pt; font-weight: bold; font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">struct</span> <span style="text-indent: 21pt; font-weight: bold; font-family: 新宋体; color: rgb(43, 145, 175); background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">event_base</span> <span style="text-indent: 21pt; font-weight: bold; font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">*base);<span style="font-size: 12pt; font-weight: bold; font-family: 新宋体; color: black;">//循环监听 常用 等价于epoll-epoll_wait</span></span></font></div></div><div><br/></div><div>退出循环监听事件</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: blue; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">int</span> <span style="font-weight: bold; font-size: 9.5pt; font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">event_base_loopexit(</span><span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: blue; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">struct</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: #2B91AF; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">event_base</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">*base,</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: blue; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">const</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: blue; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">struct</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: #2B91AF; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">timeval</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">*tv);</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-font-kerning: 0pt; mso-tab-count: 1;-en-paragraph:true;"> </span><span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: blue; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">int</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">event_base_loopbreak(</span><span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: blue; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">struct</span> <span style="font-weight: bold; mso-bidi-font-weight: normal; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: #2B91AF; background: white; mso-highlight: white; mso-font-kerning: 0pt;-en-paragraph:true;">event_base</span> <span style="font-weight: bold; font-size: 9.5pt; font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">*base);//常用</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">struct timeval {</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="mso-tab-count: 1; font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">        </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">long</span><span style="mso-spacerun: yes; font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">tv_sec;</span><span style="mso-spacerun: yes; font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">                   </span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="mso-tab-count: 1; font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">        </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">long</span><span style="mso-spacerun: yes; font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">   </span> <span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">tv_usec;</span><span style="mso-spacerun: yes; font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">           </span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">};</span></div></div><div><br/></div><div><br/></div><div>libevent 监听流程(lfd  cfd)</div><div><br/></div><div>创建event_base结构体   <span style="font-weight: bold; font-family: Monaco; color: rgb(51, 51, 51); font-size: 12pt;">event_base_new</span></div><div><br/></div><div>初始化上树节点</div><div><br/></div><div>上树监听</div><div><br/></div><div>循环监听     <span style="text-indent: 21pt; font-weight: bold; font-family: 新宋体; color: black;-en-paragraph:true;">event_base_dispatch</span></div><div><br/></div><div>扫尾   释放event_base结构</div><div><br/></div><div><img src="day06-libevent_files/Image [2].png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>4 初始化上树节点</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 57pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">*event_new(</span><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event_base</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">*base, evutil_socket_t fd,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">short events</span><span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event_callback_fn cb</span><span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">void</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">*arg);</span></font><br/></li></ol></div><div><br/></div><div>功能: 初始化上树节点</div><div>参数: </div><div><span>    </span><span style="font-size: 12pt; min-height: 4pt; font-family: ������;">base</span> : event_base结构体地址</div><div><span style="font-size: 12pt; min-height: 4pt; font-family: ������;"><span>    </span> evutil_socket_t fd: 要上树监听文件描述符</span></div><div><span style="font-size: 12pt; min-height: 4pt; font-family: ������;"><span>    <span style="font-size: 12pt; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);">events</span><span style="font-family: ������;"> : 监听的事件</span></span><br/></span></div><div><font face="������"><span>    </span><span>    </span><span>    </span>事件</font></div><div><font face="������"><span>    </span><span>    </span></font><br/></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div style="margin: 0cm 0cm 0.0001pt 27pt; text-indent: 19pt;"><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;"><span>  </span> #define</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">EV_TIMEOUT</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">        </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">0x01</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">  </span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">//</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">超时事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">#define</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">EV_READ</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">                 </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">0x02 //</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">读事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">#define</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">EV_WRITE</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">               </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">0x04</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">//</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">写事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">#define</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">EV_SIGNAL</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">            </span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">0x08</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">    </span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">//</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">信号事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">#define</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">EV_PERSIST</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">             </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">0x10</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">  </span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">//</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">周期性触发</span></div><div><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;"><span>    </span><span>    </span>#define</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;"> </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">EV_ET</span> <span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes;">                       </span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">0x20 //</span><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black;">边缘触发，如果底层模型支持</span></div></div><span style="font-size: 12pt; min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);"><span>    </span>cb</span> : 回调函数<br/></div><div><span>    arg: 传递给回调函数 的参数</span><br/></div><div><font face="������"><span>    cb的函数原型</span></font></div><div><font face="������"><span>    </span></font><br/></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font face="������"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">typedef</span> <span style="font-family: 新宋体; color: blue; background: white;-en-paragraph:true;">void</span> <span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">(*</span><span style="font-family: 新宋体; color: rgb(43, 145, 175); background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">event_callback_fn</span><span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">)(evutil_socket_t fd,</span> <span style="font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">short events</span><span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">,</span> <span style="font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">void</span> <span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">*arg);</span></font></font></div></div><br/></div><div><font face="������"><span>返回值: 返回初始化节点的地址<br/></span></font><br/></div><div><br/></div><div><br/></div><div>5 上树下树</div><div><span>    </span><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 57pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: Calibri; color: rgb(0, 0, 255);"><br/><div style="font-size: 10pt;"></div><div style="min-height: 10pt; margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">int</span> <span style="min-height: 10pt; font-family: ������; color: rgb(51, 51, 51);-en-paragraph:true;">event_add(</span><span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 10pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event</span> <span style="min-height: 10pt; font-family: ������; color: rgb(51, 51, 51);-en-paragraph:true;">*ev,</span> <span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">const</span> <span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 10pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">timeval</span> <span style="min-height: 10pt; font-family: ������; color: rgb(51, 51, 51);-en-paragraph:true;">*timeout);</span></font></div><div style="font-size: 10pt;"></div></li></ol></div><div>功能: 将节点上树</div><div><span>    参数: </span><br/></div><div><span style="min-height: 10pt; font-family: ������; color: rgb(51, 51, 51);"><span style="font-size: 9pt;">  </span> <font style="font-size: 12pt;">     ev: 上树节点的地址</font></span></div><div><span>    </span><span>    </span><span style="font-size: 12pt; min-height: 10pt; font-family: ������; color: rgb(51, 51, 51);">timeout</span> : 一般写NULL 永久监听<br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 57pt; margin-right: 0pt; padding-left: 0pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #0000ff;"><br/><div style="min-height: 10pt; margin-top: 1em; margin-bottom: 1em;"><span style="min-height: 10pt; font-family: ������; color: #0000ff; font-size: 9pt; font-decoration: Normal;-en-paragraph:true;">int</span> <span style="min-height: 10pt; font-family: ������; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">event_del(</span><span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255); font-size: 9pt;-en-paragraph:true;">struct</span> <span style="min-height: 10pt; font-family: ������; color: rgb(43, 145, 175); font-size: 9pt;-en-paragraph:true;">event</span> <span style="min-height: 10pt; font-family: ������; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">*ev);</span></div></li></ol></div><div>功能: 将节点下树</div><div><span>    参数: 下树节点的地址</span><br/></div><div><span><br/></span></div><div>释放节点 </div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 57pt; margin-right: 0pt; padding-left: 0pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #0000ff;"><br/><div style="min-height: 10pt; margin-top: 1em; margin-bottom: 1em;"><span style="min-height: 10pt; font-family: ������; color: #0000ff; font-size: 9pt; font-decoration: Normal;-en-paragraph:true;">void</span> <span style="min-height: 10pt; font-family: ������; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">event_free(</span><span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255); font-size: 9pt;-en-paragraph:true;">struct</span> <span style="min-height: 10pt; font-family: ������; color: rgb(43, 145, 175); font-size: 9pt;-en-paragraph:true;">event</span> <span style="min-height: 10pt; font-family: ������; font-size: 9pt; color: rgb(51, 51, 51);-en-paragraph:true;">*ev);</span></div></li></ol></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span>6 bufferevent 高级事件</span></div><div><span><br/></span></div><div><span><br/></span></div><div>普通的event事件     一个文件描述符   一个回调</div><div>高级的bufferevent事件   1个文件描述符  2个缓冲区  3个回调</div><div><span><br/></span></div><div><span><br/></span></div><div><img src="day06-libevent_files/Image [3].png" type="image/png" data-filename="Image.png"/></div><div><span><br/></span></div><div><span><br/></span></div><div><span>7 event事件和bufferevent事件API比较</span></div><div><span><br/></span></div><div><img src="day06-libevent_files/Image [4].png" type="image/png" data-filename="Image.png"/></div><div><span><br/></span></div><div><span><br/></span></div><div><span>8 创建一个bufferevent节点</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><br/><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">bufferevent *bufferevent_socket_new(</span><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">event_base *base, evutil_socket_t fd,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">int</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">options);</span><br/></font></li></ol><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 6pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">bufferevent_socket_new 对已经存在socket创建bufferevent事件，可用于后面讲到的链接监听器的回调函数中，参数说明：</font></span></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 9pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: Calibri; color: rgb(1, 1, 1);">         base –</span> <span style="text-indent: 0mm; min-height: 9pt; font-family: 宋体; color: rgb(1, 1, 1);">对应根节点</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 9pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: Calibri; color: rgb(1, 1, 1);">         fd   --</span> <span style="text-indent: 0mm; min-height: 9pt; font-family: 宋体; color: rgb(1, 1, 1);">文件描述符</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 9pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 9pt; font-family: Calibri; color: rgb(1, 1, 1);">         options – bufferevent</span><span style="text-indent: 0mm; min-height: 9pt; font-family: 宋体; color: rgb(1, 1, 1);">的选项</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 6pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: Calibri; color: rgb(1, 1, 1);">                  </span><span style="text-indent: 0mm; min-height: 6pt; font-family: ������; color: rgb(51, 51, 51);">BEV_OPT_CLOSE_ON_FREE   -- 释放bufferevent自动关闭底层接口   </span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">         BEV_OPT_THREADSAFE      -- 使bufferevent能够在多线程下是安全的</font></span></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 12pt;"><font face="������"><span style="font-size: 16px;">返回值: 新建节点的地址</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 12pt;"></div><div><font style="font-size: 12pt;">释放<span style="min-height: 4pt; font-family: ������; color: rgb(51, 51, 51);">bufferevent</span><span style="font-family: Monaco; color: rgb(51, 51, 51);"> 节点</span></font><br/><div style="font-size: 9pt;"></div><div style="min-height: 10pt; margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;-en-paragraph:true;">void</span> <span style="min-height: 10pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);-en-paragraph:true;">bufferevent_free(</span><span style="min-height: 10pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;-en-paragraph:true;">struct</span> <span style="min-height: 10pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);-en-paragraph:true;">bufferevent *bufev);</span></font></div><div style="font-size: 9pt;"></div></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 12pt;"><span style="text-indent: 0mm; min-height: 12pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;"><br/></font></span></div></div><div><span><br/></span></div><div><span>9 设置节点的回调</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; font-weight: bold; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="font-family: ������; font-weight: bold;">bufferevent_setcb(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">bufferevent *bufev,</span></font></li></ol><div style="min-height: 10pt;"><span style="min-height: 10pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    bufferevent_data_cb readcb, bufferevent_data_cb writecb,</font></span></div><div style="margin: 2.11mm 0mm; text-indent: 7mm; min-height: 4pt;"><font style="font-size: 12pt;"><span style="text-indent: 7mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">bufferevent_event_cb eventcb,</span> <span style="text-indent: 7mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="text-indent: 7mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">*cbarg);</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 6pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: Calibri; color: rgb(1, 1, 1);">         </span><span style="text-indent: 0mm; min-height: 6pt; font-family: ������; color: rgb(51, 51, 51);">bufferevent_setcb用于设置bufferevent的回调函数，readcb，writecb，eventcb分别对应了读回调，写回调，事件回调，cbarg代表回调函数的参数。</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 6pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    回调函数的原型：</font></span></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 6pt;"><font face="������" style="font-size: 12pt;">读写回调:</font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 4pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(51, 51, 51);">    </span><span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">typedef</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">(*bufferevent_data_cb)(</span><span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">bufferevent *bev,</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">*ctx);</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 4pt;"><font face="������" style="font-size: 12pt;"><b>事件回调:</b></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 4pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">    </span><span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">typedef</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">(*bufferevent_event_cb)(</span><span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">bufferevent *bev,</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">short</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">what,</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="text-indent: 0mm; min-height: 4pt; font-family: ������; font-weight: bold; color: rgb(51, 51, 51);">*ctx);</span></font></div><ul style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt; list-style-type: disc;"><li style="margin-left: 57pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><br/><span style="min-height: 6pt; font-family: ������; color: rgb(0, 0, 0);-en-paragraph:true;">What 代表 对应的事件</span><span style="min-height: 6pt; font-family: ������; color: rgb(0, 128, 0);-en-paragraph:true;">BEV_EVENT_EOF(对应的文件描述符关闭), BEV_EVENT_ERROR(出错)，BEV_EVENT_TIMEOUT(超时), BEV_EVENT_CONNECTED(连接成功)</span></font><br/></li></ul></div><div><span><br/></span></div><div><span>9 让事件使能或不使能</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent:0pt; font-family: ������; font-size: 9pt; font-weight: Bold; color: #0000ff;"><span style="font-family: ������; color: #0000ff; font-size: 9pt; font-decoration: Normal; font-weight: bold;">int</span> <span style="font-family: ������; font-size: 9pt; font-weight: bold;">bufferevent_enable(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">struct</span> <span style="font-family: ������; font-size: 9pt; font-weight: bold;">bufferevent *bufev,</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">short</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">event</span><span style="font-family: ������; font-size: 9pt; font-weight: bold;">);//<span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">event  </span></span></li><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent:0pt; font-family: ������; font-size: 9pt; color: #0000ff;"><span style="font-family: ������; color: #0000ff; font-size: 9pt; font-decoration: Normal; font-weight: bold;">int</span> <span style="font-family: ������; font-size: 9pt; font-weight: bold;">bufferevent_disable(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">struct</span> <span style="font-family: ������; font-size: 9pt; font-weight: bold;">bufferevent *bufev,</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">short</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-size: 9pt; font-weight: bold;">event</span><span style="font-family: ������; font-size: 9pt; font-weight: bold;">);</span></li></ol><div><font color="#0000FF" face="������"><b><br/></b></font></div><div><font color="#0000FF" face="������"><b>事件:</b></font></div><div style="margin: 0cm 0cm 0.0001pt 27pt; text-indent: 19pt;"><span style="text-indent: 19pt; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: 宋体; mso-bidi-font-family: 新宋体; color: black; mso-tab-count: 1; font-weight: bold;">   </span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">#define</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">EV_TIMEOUT</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">        </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">0x01</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">  </span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">//</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">超时事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">#define</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">EV_READ</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">                 </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">0x02 //</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">读事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">#define</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">EV_WRITE</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">               </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">0x04</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">//</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">写事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">#define</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">EV_SIGNAL</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">            </span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">0x08</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">    </span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">//</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">信号事件</span></div><div style="margin: 0cm 0cm 0.0001pt 48pt; text-indent: 19pt;"><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">#define</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">EV_PERSIST</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">             </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">0x10</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">  </span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">//</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">周期性触发</span></div><div><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;"><span>    </span><span>    </span><span> </span>#define</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;"> </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">EV_ET</span> <span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; mso-spacerun: yes; font-weight: bold;">                       </span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">0x20 //</span><span style="text-indent: 19pt; mso-bookmark: OLE_LINK27; font-size: 9.5pt; font-family: 新宋体; mso-hansi-font-family: Calibri; mso-bidi-font-family: 新宋体; color: black; font-weight: bold;">边缘触发，如果底层模型支持</span></div></div><div><span><br/></span></div><div><span><br/></span></div><div><span>10 读写数据<br/></span><br/></div><div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; font-weight: bold; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">int</span> <span style="font-family: ������; font-weight: bold;">bufferevent_write(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">bufferevent *bufev,</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">const</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="font-family: ������; font-weight: bold;">*data, size_t size);//常用</span></font></li></ol><div style="min-height: 12pt;"><font style="font-size: 12pt;"><span style="min-height: 12pt; font-family: ������; color: rgb(51, 51, 51);">    </span><span style="min-height: 12pt; font-family: ������; color: rgb(191, 143, 0);">bufferevent_write是将data的数据写到bufferevent的写缓冲区</span></font></div><ol start="2" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; font-weight: bold; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">int</span> <span style="font-family: ������; font-weight: bold;">bufferevent_write_buffer(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">bufferevent *bufev,</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">evbuffer *buf);</span></font></li></ol><div style="min-height: 12pt;"><span style="min-height: 12pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    bufferevent_write_buffer 是将数据写到写缓冲区另外一个写法，实际上bufferevent的内部的两个缓冲区结构就是struct evbuffer。</font></span></div><ol start="3" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; font-weight: bold; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><span style="font-family: ������; color: rgb(0, 0, 0); font-weight: bold;">size_t bufferevent_read(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">bufferevent *bufev,</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">void</span> <span style="font-family: ������; font-weight: bold;">*data, size_t size);//常用</span></font></li></ol><div style="min-height: 12pt;"><span style="min-height: 12pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">    bufferevent_read 是将bufferevent的读缓冲区数据读到data中，同时将读到的数据从bufferevent的读缓冲清除。</font></span></div><ol start="4" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; font-weight: bold; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">int</span> <span style="font-family: ������; font-weight: bold;">bufferevent_read_buffer(</span><span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">bufferevent *bufev,</span> <span style="font-family: ������; color: rgb(0, 0, 255); font-weight: bold;">struct</span> <span style="font-family: ������; font-weight: bold;">evbuffer *buf);</span></font></li></ol></div><br/></div><div><span><br/></span><br/></div><div><span>11 连接侦听器</span></div><div>tcp服务器实现流程</div><div>创建套接字</div><div>绑定</div><div>监听</div><div>提取</div><div><br/></div><div>连接侦听器把以上4步全做了</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: Calibri; color: rgb(1, 1, 1);"><font style="font-size: 12pt;"><br/><span style="min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1);">struct evconnlistener *evconnlistener_new_bind(struct event_base *base,</span><br/></font></li></ol><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">    evconnlistener_cb cb, void *ptr, unsigned flags, int backlog,</font></span></div><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 7mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 13pt;"><span style="text-indent: 7mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1);"><font style="font-size: 12pt;">const struct sockaddr *sa, int socklen);</font></span></div></div><div><span><br/></span></div><div>函数功能: 创建一个连接侦听器</div><div><br/></div><div>参数: </div><div><span>    </span><span style="font-size: 12pt; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1);">base</span> : 根节点<br/></div><div><span><span>    </span><span style="text-indent: 0mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1); font-size: 12pt;">cb</span> : 提取新的连接之后要回调的函数<br/></span></div><div><span>    <font color="#010101" face="Calibri">ptr::传给回调函数的参数</font><br/></span></div><div><span><font color="#010101" face="Calibri"><span>    <span style="text-indent: 0mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1); font-size: 12pt;">flags</span><span style="font-family: Calibri; color: rgb(1, 1, 1);"> :</span></span><br/></font></span></div><div><span><font color="#010101" face="Calibri"><span style="font-family: Calibri; color: rgb(1, 1, 1);"><span>    </span><span>    </span><span>    </span> </span></font></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;"><span>    </span><span>    </span>LEV_OPT_LEAVE_SOCKETS_BLOCKING</span><span style="mso-spacerun: yes; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">  </span> <span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">文件描述符为阻塞的</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="mso-tab-count: 1; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">        </span> <span style="font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">LEV_OPT_CLOSE_ON_FREE</span><span style="mso-spacerun: yes; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">           </span> <span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">关闭时自动释放//常用</span></div><div style="margin-top: 1em; margin-bottom: 1em;"><span style="mso-tab-count: 1; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">        </span> <span style="font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">LEV_OPT_REUSEABLE</span><span style="mso-spacerun: yes; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">               </span> <span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">端口复用</span></div><div><span><font color="#010101" face="Calibri"><span style="font-family: Calibri; color: rgb(1, 1, 1);"><br/></span></font></span><span style="mso-tab-count: 1; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">        </span> <span style="font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">LEV_OPT_THREADSAFE</span><span style="mso-spacerun: yes; font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">              </span> <span style="font-family: 宋体; mso-ascii-font-family: Calibri; mso-hansi-font-family: Calibri; color: rgb(1, 1, 1);-en-paragraph:true;">分配锁，线程安全</span></div><div><span style="text-indent: 0mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1); font-size: 12pt;">backlog: listen连接队列的长度  -1 自动选择   如果填0,代表这里不需要做listen,在外面做了</span></div><div><span style="text-indent: 7mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1); font-size: 12pt;">sa: 绑定的地址信息结构体</span></div><div><span style="text-indent: 7mm; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1); font-size: 12pt;">socklen: sa结构体的长度</span></div><div>返回值:返回的是连接侦听器的地址</div><div>回调函数:</div><div><span style="-en-paragraph:true;">typedef void (*evconnlistener_cb)(struct evconnlistener *evl, evutil_socket_t fd, struct sockaddr *cliaddr, int socklen, void *ptr);</span></div><div><span><br/></span></div><div>evl: 连接侦听器地址</div><div>fd:  提取的新的连接的套接字cfd</div><div>cliaddr: 提取新的联系的地址信息</div><div>socklen: cliaddr的结构体长度</div><div>ptr: <span style="font-size: 12pt; min-height: 13pt; font-family: Calibri; color: rgb(1, 1, 1);">evconnlistener_new_bind函数传入的</span></div><div><span><br/></span></div><div><span><br/></span></div><div>释放连接侦听器和使连接侦听器使能</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><br/><span style="min-height: 13pt; font-family: Calibri; color: #010101; font-size: 10pt; font-decoration: Normal;">void evconnlistener_free(struct evconnlistener *lev);</span><br/></li></ol><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt; font-family: 宋体; color: rgb(1, 1, 1); font-size: 10pt;">释放链接监听器</span></div><ol start="2" style="margin-top: 0mm; margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent:0pt; font-family: Calibri; font-size: 10pt; color: #010101;"><br/><span style="min-height: 13pt; font-family: Calibri; color: #010101; font-size: 10pt; font-decoration: Normal;">int evconnlistener_enable(struct evconnlistener *lev);</span><br/></li></ol><div style="margin-left: 6mm; margin-right: 0mm; text-indent: 0mm; margin-top: 0.00mm; margin-bottom: 0.00mm; min-height: 13pt;"><span style="text-indent: 0mm; min-height: 13pt; font-family: 宋体; color: rgb(1, 1, 1); font-size: 10pt;">使链接监听器生效</span></div></div><div><span><br/></span></div><div><span><br/></span></div><div style="margin-top: 1em; margin-bottom: 1em;"><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: blue; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">#define</span> <span style="font-family: 新宋体; color: rgb(111, 0, 138); background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">evsignal_new</span><span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">(b, x, cb, arg)</span><span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">             </span> <span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">\</span></font></div><div><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">event_new((b), (x),</span> <span style="font-family: 新宋体; color: rgb(111, 0, 138); background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">EV_SIGNAL</span><span style="font-family: 新宋体; color: black; background: white;-en-paragraph:true;">|</span><span style="font-family: 新宋体; color: rgb(111, 0, 138); background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">EV_PERSIST</span><span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;">, (cb), (arg))</span></font></div><div><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;"><br/></span></font></div><div><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;"><br/></span></font></div><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 57pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; color: rgb(0, 0, 255);"><font style="font-size: 12pt;"><br/><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">*event_new(</span><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event_base</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">*base, evutil_socket_t fd,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">short events</span><span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175);-en-paragraph:true;">event_callback_fn cb</span><span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255);-en-paragraph:true;">void</span> <span style="min-height: 4pt; font-family: ������;-en-paragraph:true;">*arg);</span><br/></font></li></ol><div><font style="font-size: 12pt;"><span style="font-family: 新宋体; color: black; background-image: initial; background-position: initial; background-size: initial; background-repeat: initial; background-attachment: initial; background-origin: initial; background-clip: initial;-en-paragraph:true;"><br/></span></font></div><div><span><br/></span></div><div>连接服务器</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><ol style="margin-bottom: 0mm; margin-left: 0mm; padding-left: 0pt;"><li style="margin-left: 15pt; margin-right: 0pt; padding-left: 0pt; text-indent: 0pt; font-family: ������; font-weight: bold; color: rgb(0, 0, 255);"><br/><font style="font-size: 12pt;"><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;-en-paragraph:true;">int</span> <span style="min-height: 4pt; font-family: ������; font-weight: bold;-en-paragraph:true;">bufferevent_socket_connect(</span><span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175); font-weight: bold;-en-paragraph:true;">bufferevent</span> <span style="min-height: 4pt; font-family: ������; font-weight: bold;-en-paragraph:true;">*bev,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;-en-paragraph:true;">struct</span> <span style="min-height: 4pt; font-family: ������; color: rgb(43, 145, 175); font-weight: bold;-en-paragraph:true;">sockaddr</span> <span style="min-height: 4pt; font-family: ������; font-weight: bold;-en-paragraph:true;">*serv,</span> <span style="min-height: 4pt; font-family: ������; color: rgb(0, 0, 255); font-weight: bold;-en-paragraph:true;">int</span> <span style="min-height: 4pt; font-family: ������; font-weight: bold;-en-paragraph:true;">socklen);</span><br/></font></li></ol><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 6pt;"><span style="text-indent: 0mm; min-height: 6pt; font-family: ������; color: rgb(51, 51, 51);"><font style="font-size: 12pt;">bufferevent_socket_connect封装了底层的socket与connect接口，通过调用此函数，可以将bufferevent事件与通信的socket进行绑定，参数如下：</font></span></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 7pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: ������; color: rgb(51, 51, 51);">    bev</span> <span style="text-indent: 0mm; min-height: 7pt; font-family: Calibri; color: rgb(51, 51, 51);">–</span> <span style="text-indent: 0mm; min-height: 7pt; font-family: ������; color: rgb(51, 51, 51);">需要提前初始化的bufferevent事件</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 7pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 7pt; font-family: ������; color: rgb(51, 51, 51);">    serv</span> <span style="text-indent: 0mm; min-height: 7pt; font-family: Calibri; color: rgb(51, 51, 51);">–</span> <span style="text-indent: 0mm; min-height: 7pt; font-family: ������; color: rgb(51, 51, 51);">对端的ip地址，端口，协议的结构指针</span></font></div><div style="margin: 2.11mm 0mm; text-indent: 0mm; min-height: 13pt;"><font style="font-size: 12pt;"><span style="text-indent: 0mm; min-height: 13pt; font-family: ������; color: rgb(51, 51, 51);">    socklen</span> <span style="text-indent: 0mm; min-height: 13pt; font-family: Calibri; color: rgb(51, 51, 51);">–</span> <span style="text-indent: 0mm; min-height: 13pt; font-family: ������; color: rgb(51, 51, 51);">描述serv的长度</span></font></div></div><div><span><br/></span></div><div><span><br/></span></div><div><span>12 bufferevent实现tcp客户端流程</span></div><div>创建套接字</div><div>可以不绑定</div><div>连接</div><div>创建base根节点</div><div>初始化节点 sockerfd   stdin</div><div>将节点上树监听</div><div>循环监听</div><div>扫尾</div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><span><br/></span></div><div><br/></div></div></span>
</div></body></html> 